<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>RLC Bingo Manager</title>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Progressive Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* ==================== CSS Variables ==================== */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
            --background-color: #f5f5f5;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --header-height: 56px;
            --nav-height: 56px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-primary);
            touch-action: pan-y;
        }
        
        /* ==================== Login Screen ==================== */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            padding: 40px 30px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }
        
        .login-button:active {
            transform: scale(0.98);
        }
        
        .login-error {
            color: var(--error-color);
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        
        /* ==================== Dashboard Container ==================== */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            background: var(--background-color);
        }
        
        .dashboard-container.active {
            display: block;
        }
        
        /* ==================== Mobile Header ==================== */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .logout-icon {
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        /* ==================== Content Area ==================== */
        .content-area {
            padding-top: var(--header-height);
            padding-bottom: var(--nav-height);
            min-height: 100vh;
        }
        
        .content-section {
            display: none;
            padding: 20px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .content-section.active {
            display: block;
        }
        
        /* ==================== Dashboard Stats Grid ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s;
        }
        
        .stat-card:active {
            transform: scale(0.98);
        }
        
        .stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .stat-card.primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .stat-card.success { background: linear-gradient(135deg, #66bb6a, #43a047); color: white; }
        .stat-card.warning { background: linear-gradient(135deg, #ffa726, #ff9800); color: white; }
        .stat-card.info { background: linear-gradient(135deg, #42a5f5, #2196f3); color: white; }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ==================== Quick Actions ==================== */
        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .action-button {
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
        }
        
        .action-button:active {
            transform: scale(0.98);
        }
        
        .action-button.success {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }
        
        .action-button .material-icons {
            font-size: 24px;
        }
        
        /* ==================== Form Styles ==================== */
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 480px) {
            .input-grid.two-column {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .submit-button {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .submit-button:active {
            transform: scale(0.98);
        }
        
        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ==================== Pull Tab List ==================== */
        .game-list {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        
        .game-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .game-item:active {
            background: var(--background-color);
        }
        
        .game-item:last-child {
            border-bottom: none;
        }
        
        .game-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .game-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .game-prize {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .game-manufacturer {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ==================== Bottom Navigation ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        
        /* ==================== Loading States ==================== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 15px;
            font-size: 14px;
        }
        
        /* ==================== Toast Notifications ==================== */
        .toast {
            position: fixed;
            top: calc(var(--header-height) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
            min-width: 250px;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.error { border-left: 4px solid var(--error-color); }
        .toast.warning { border-left: 4px solid var(--warning-color); }
        .toast.info { border-left: 4px solid var(--info-color); }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--error-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }
        
        /* ==================== Report List ==================== */
        .report-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .report-item {
            padding: 15px;
            background: var(--background-color);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-item:active {
            transform: scale(0.98);
            background: #e8eaf6;
        }
        
        .report-info {
            flex: 1;
        }
        
        .report-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .report-description {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .report-icon {
            color: var(--primary-color);
            font-size: 24px;
        }
        
        /* ==================== Responsive Adjustments ==================== */
        @media (min-width: 768px) {
            .content-area {
                max-width: 768px;
                margin: 0 auto;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* ==================== iOS Safe Areas ==================== */
        @supports (padding: max(0px)) {
            .mobile-header {
                padding-top: max(0px, env(safe-area-inset-top));
                height: calc(var(--header-height) + env(safe-area-inset-top));
            }
            
            .content-area {
                padding-top: calc(var(--header-height) + env(safe-area-inset-top));
                padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom));
            }
            
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
                height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">ü¶Å</div>
                <h1 class="login-title">RLC Bingo</h1>
                <p class="login-subtitle">Closet Reporting System</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" required autocomplete="username" autocapitalize="off">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-button" id="loginBtn">Sign In</button>
                <div class="login-error" id="loginError"></div>
            </form>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardScreen">
        <!-- Fixed Header -->
        <div class="mobile-header">
            <h1 class="header-title" id="pageTitle">Dashboard</h1>
            <div class="header-user">
                <span id="userName">User</span>
                <span class="material-icons logout-icon" onclick="logout()">logout</span>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboardSection">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <span class="material-icons stat-icon">attach_money</span>
                        <div class="stat-value" id="todaySales">$0</div>
                        <div class="stat-label">Today's Sales</div>
                    </div>
                    <div class="stat-card success">
                        <span class="material-icons stat-icon">people</span>
                        <div class="stat-value" id="todayPlayers">0</div>
                        <div class="stat-label">Players Today</div>
                    </div>
                    <div class="stat-card warning">
                        <span class="material-icons stat-icon">confirmation_number</span>
                        <div class="stat-value" id="activeGames">0</div>
                        <div class="stat-label">Active Games</div>
                    </div>
                    <div class="stat-card info">
                        <span class="material-icons stat-icon">trending_up</span>
                        <div class="stat-value" id="weekTotal">$0</div>
                        <div class="stat-label">Week Total</div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <h2 class="section-title">Quick Actions</h2>
                    <div class="action-buttons">
                        <button class="action-button" onclick="navigateTo('doorSales')">
                            <span class="material-icons">point_of_sale</span>
                            <span>Door Sales</span>
                        </button>
                        <button class="action-button success" onclick="navigateTo('pullTabs')">
                            <span class="material-icons">confirmation_number</span>
                            <span>Pull Tabs</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">Recent Activity</h2>
                    <div id="recentActivity">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Door Sales Section -->
            <div class="content-section" id="doorSalesSection">
                <form id="doorSalesForm">
                    <div class="form-section">
                        <h2 class="section-title">Session Information</h2>
                        <div class="input-grid two-column">
                            <div>
                                <label class="form-label">Date</label>
                                <input type="date" id="salesDate" class="input-field" required>
                            </div>
                            <div>
                                <label class="form-label">Players</label>
                                <input type="number" id="playerCount" class="input-field" placeholder="0" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2 class="section-title">Paper Sales</h2>
                        <div class="input-grid two-column">
                            <div>
                                <label class="form-label">6 Face ($10)</label>
                                <input type="number" id="paper6Face" class="input-field" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="form-label">9 Solid ($15)</label>
                                <input type="number" id="paper9Solid" class="input-field" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="form-label">9 Stripe ($10)</label>
                                <input type="number" id="paper9Stripe" class="input-field" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="form-label">Early Bird ($2.50)</label>
                                <input type="number" id="paperEarlybird" class="input-field" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2 class="section-title">Electronic & Other</h2>
                        <div class="input-grid two-column">
                            <div>
                                <label class="form-label">Electronic $40</label>
                                <input type="number" id="elec40" class="input-field" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="form-label">Electronic $65</label>
                                <input type="number" id="elec65" class="input-field" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="form-label">Daubers ($2)</label>
                                <input type="number" id="daubers" class="input-field" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="form-label">Total</label>
                                <input type="text" id="doorSalesTotal" class="input-field" readonly value="$0.00">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-button" id="saveDoorSalesBtn">
                        Save Door Sales
                    </button>
                </form>
            </div>
            
            <!-- Pull Tabs Section -->
            <div class="content-section" id="pullTabsSection">
                <div class="form-section">
                    <h2 class="section-title">Available Games</h2>
                    <div class="game-list" id="gameList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading games...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2 class="section-title">Record Sale</h2>
                    <div class="input-grid">
                        <div>
                            <label class="form-label">Select Game</label>
                            <select id="gameSelect" class="input-field" required>
                                <option value="">Choose a game...</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Sale Amount</label>
                            <input type="number" id="saleAmount" class="input-field" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                    </div>
                    <button class="submit-button" onclick="recordPullTabSale()">
                        Record Pull Tab Sale
                    </button>
                </div>
            </div>
            
            <!-- Reports Section -->
            <div class="content-section" id="reportsSection">
                <div class="report-list">
                    <h2 class="section-title">Generate Reports</h2>
                    
                    <div class="report-item" onclick="generateReport('daily')">
                        <div class="report-info">
                            <div class="report-title">Daily Summary</div>
                            <div class="report-description">Today's sales and activity</div>
                        </div>
                        <span class="material-icons report-icon">today</span>
                    </div>
                    
                    <div class="report-item" onclick="generateReport('weekly')">
                        <div class="report-info">
                            <div class="report-title">Weekly Report</div>
                            <div class="report-description">7-day performance summary</div>
                        </div>
                        <span class="material-icons report-icon">date_range</span>
                    </div>
                    
                    <div class="report-item" onclick="generateReport('monthly')">
                        <div class="report-info">
                            <div class="report-title">Monthly Board Report</div>
                            <div class="report-description">For board of directors</div>
                        </div>
                        <span class="material-icons report-icon">assessment</span>
                    </div>
                    
                    <div class="report-item" onclick="generateReport('quarterly')">
                        <div class="report-info">
                            <div class="report-title">Quarterly MGC Report</div>
                            <div class="report-description">Missouri Gaming Commission</div>
                        </div>
                        <span class="material-icons report-icon">account_balance</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navigateTo('dashboard')">
                <span class="material-icons nav-icon">dashboard</span>
                <span class="nav-label">Dashboard</span>
            </div>
            <div class="nav-item" onclick="navigateTo('doorSales')">
                <span class="material-icons nav-icon">point_of_sale</span>
                <span class="nav-label">Door Sales</span>
            </div>
            <div class="nav-item" onclick="navigateTo('pullTabs')">
                <span class="material-icons nav-icon">confirmation_number</span>
                <span class="nav-label">Pull Tabs</span>
            </div>
            <div class="nav-item" onclick="navigateTo('reports')">
                <span class="material-icons nav-icon">assessment</span>
                <span class="nav-label">Reports</span>
            </div>
        </nav>
    </div>
    
    <!-- Toast Container -->
    <div class="toast" id="toast">
        <span class="material-icons toast-icon" id="toastIcon">info</span>
        <span id="toastMessage">Message</span>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            spreadsheetId: '1pmJO2WFi--TJs4kr1pFhKxBXEw4AiZdmrTIQ1_HBrVM',
            apiKey: 'AIzaSyCPcWHEm0KLyp-8DVKfEm_gYn9pfyxBmmQ',
            scriptUrl: 'https://script.google.com/macros/s/AKfycbyAo1IsuFempsKZ3pE9fbxFImbFI-Ff2fpn6DJZEhlLXpkFrQJo6cdvyoOj4T1QkHmskg/exec'
        };
        
        // ============================================
        // APPLICATION STATE
        // ============================================
        let currentUser = null;
        let pullTabGames = [];
        let doorSalesData = [];
        
        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // Set today's date as default
            document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
            
            // Check for saved session
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Calculate totals in real-time
            setupDoorSalesCalculator();
        }
        
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Door sales form
            document.getElementById('doorSalesForm').addEventListener('submit', handleDoorSales);
            
            // Add input listeners for all number fields to calculate total
            const doorSalesInputs = [
                'paper6Face', 'paper9Solid', 'paper9Stripe', 'paperEarlybird',
                'elec40', 'elec65', 'daubers'
            ];
            
            doorSalesInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculateDoorSalesTotal);
                }
            });
        }
        
        // ============================================
        // AUTHENTICATION
        // ============================================
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            // Clear previous error
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Disable button and show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            
            try {
                // For GitHub deployment, we need to verify credentials differently
                // We'll use a simple check against known users for now
                const validUsers = {
                    'wigginsb': { password: 'wig2866', name: 'B. Wiggins', role: 'admin' },
                    'williamsm': { password: 'wil0387', name: 'M. Williams', role: 'admin' },
                    'asberryw': { password: 'asb0260', name: 'W. Asberry', role: 'closet' },
                    'parryw': { password: 'par9666', name: 'W. Parry', role: 'closet' },
                    'hribarc': { password: 'hri0643', name: 'C. Hribar', role: 'closet' },
                    'eppersonb': { password: 'epp3532', name: 'B. Epperson', role: 'closet' },
                    'masonb': { password: 'mas4830', name: 'B. Mason', role: 'view' }
                };
                
                if (validUsers[username] && validUsers[username].password === password) {
                    currentUser = {
                        username: username,
                        name: validUsers[username].name,
                        role: validUsers[username].role
                    };
                    
                    // Save to session
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Show dashboard
                    showDashboard();
                    showToast(`Welcome, ${currentUser.name}!`, 'success');
                } else {
                    errorDiv.textContent = 'Invalid username or password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;
            
            // Load initial data
            loadDashboardData();
            loadPullTabGames();
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('currentUser');
                currentUser = null;
                document.getElementById('dashboardScreen').classList.remove('active');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showToast('Logged out successfully', 'info');
            }
        }
        
        // ============================================
        // NAVIGATION
        // ============================================
        function navigateTo(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => {
                s.classList.remove('active');
            });
            
            // Remove active from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section + 'Section').classList.add('active');
            
            // Update nav
            const navItems = document.querySelectorAll('.nav-item');
            const sectionIndex = ['dashboard', 'doorSales', 'pullTabs', 'reports'].indexOf(section);
            if (sectionIndex >= 0 && navItems[sectionIndex]) {
                navItems[sectionIndex].classList.add('active');
            }
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                doorSales: 'Door Sales Entry',
                pullTabs: 'Pull Tab Management',
                reports: 'Reports'
            };
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
        }
        
        // ============================================
        // GOOGLE SHEETS API - READ OPERATIONS
        // ============================================
        async function readSheetData(range) {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${range}?key=${CONFIG.apiKey}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to read data');
                }
                
                const data = await response.json();
                return data.values || [];
                
            } catch (error) {
                console.error('Read error:', error);
                return [];
            }
        }
        
        async function loadDashboardData() {
            try {
                // Load door sales data
                const salesData = await readSheetData('DoorSales!A:T');
                if (salesData.length > 1) {
                    const today = new Date().toISOString().split('T')[0];
                    let todaySales = 0;
                    let todayPlayers = 0;
                    let weekTotal = 0;
                    
                    // Skip header row
                    for (let i = 1; i < salesData.length; i++) {
                        const row = salesData[i];
                        const rowDate = row[1]; // Date column
                        const grandTotal = parseFloat(row[17]) || 0; // GrandTotal column
                        const players = parseInt(row[4]) || 0; // Players column
                        
                        if (rowDate === today) {
                            todaySales += grandTotal;
                            todayPlayers += players;
                        }
                        
                        // Check if within last 7 days
                        const rowDateObj = new Date(rowDate);
                        const daysDiff = (new Date() - rowDateObj) / (1000 * 60 * 60 * 24);
                        if (daysDiff <= 7) {
                            weekTotal += grandTotal;
                        }
                    }
                    
                    document.getElementById('todaySales').textContent = `$${todaySales.toFixed(2)}`;
                    document.getElementById('todayPlayers').textContent = todayPlayers;
                    document.getElementById('weekTotal').textContent = `$${weekTotal.toFixed(2)}`;
                }
                
                // Load pull tab games count
                const gamesData = await readSheetData('PullTabLibrary!A:N');
                const activeGames = gamesData.filter(row => row[13] === 'TRUE').length - 1; // Minus header
                document.getElementById('activeGames').textContent = activeGames;
                
                // Load recent activity
                updateRecentActivity(salesData.slice(-5).reverse()); // Last 5 entries
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        async function loadPullTabGames() {
            try {
                const gamesData = await readSheetData('PullTabLibrary!A:N');
                
                if (gamesData.length > 1) {
                    pullTabGames = [];
                    const gameListHtml = [];
                    const selectOptions = ['<option value="">Choose a game...</option>'];
                    
                    // Skip header row
                    for (let i = 1; i < gamesData.length; i++) {
                        const game = {
                            gameName: gamesData[i][0],
                            topPrize: gamesData[i][1],
                            formNumber: gamesData[i][3],
                            manufacturer: gamesData[i][4],
                            pricePerTicket: gamesData[i][6],
                            active: gamesData[i][13] === 'TRUE'
                        };
                        
                        if (game.active) {
                            pullTabGames.push(game);
                            
                            // Add to display list
                            gameListHtml.push(`
                                <div class="game-item">
                                    <div>
                                        <div class="game-name">${game.gameName}</div>
                                        <div class="game-manufacturer">${game.manufacturer}</div>
                                    </div>
                                    <div class="game-info">
                                        <span class="game-prize">$${game.topPrize}</span>
                                    </div>
                                </div>
                            `);
                            
                            // Add to select options
                            selectOptions.push(`<option value="${game.formNumber}">${game.gameName} - $${game.topPrize}</option>`);
                        }
                    }
                    
                    document.getElementById('gameList').innerHTML = gameListHtml.join('');
                    document.getElementById('gameSelect').innerHTML = selectOptions.join('');
                }
            } catch (error) {
                console.error('Error loading pull tab games:', error);
                document.getElementById('gameList').innerHTML = '<p style="text-align: center; color: #666;">Failed to load games</p>';
            }
        }
        
        function updateRecentActivity(recentSales) {
            if (!recentSales || recentSales.length === 0) {
                document.getElementById('recentActivity').innerHTML = '<p style="text-align: center; color: #666;">No recent activity</p>';
                return;
            }
            
            const activityHtml = recentSales.map(sale => {
                if (!sale || sale.length < 18) return '';
                return `
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 500;">${sale[1]} - ${sale[2]}</div>
                        <div style="font-size: 12px; color: #666;">Players: ${sale[4]} | Total: $${sale[17]}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('recentActivity').innerHTML = activityHtml || '<p style="text-align: center; color: #666;">No recent activity</p>';
        }
        
        // ============================================
        // DOOR SALES CALCULATOR
        // ============================================
        function setupDoorSalesCalculator() {
            calculateDoorSalesTotal();
        }
        
        function calculateDoorSalesTotal() {
            const paper6Face = parseInt(document.getElementById('paper6Face').value) || 0;
            const paper9Solid = parseInt(document.getElementById('paper9Solid').value) || 0;
            const paper9Stripe = parseInt(document.getElementById('paper9Stripe').value) || 0;
            const paperEarlybird = parseInt(document.getElementById('paperEarlybird').value) || 0;
            const elec40 = parseInt(document.getElementById('elec40').value) || 0;
            const elec65 = parseInt(document.getElementById('elec65').value) || 0;
            const daubers = parseInt(document.getElementById('daubers').value) || 0;
            
            const paperTotal = (paper6Face * 10) + (paper9Solid * 15) + (paper9Stripe * 10) + (paperEarlybird * 2.5);
            const electronicTotal = (elec40 * 40) + (elec65 * 65);
            const miscTotal = daubers * 2;
            const grandTotal = paperTotal + electronicTotal + miscTotal;
            
            document.getElementById('doorSalesTotal').value = `$${grandTotal.toFixed(2)}`;
            
            return {
                paperTotal,
                electronicTotal,
                miscTotal,
                grandTotal
            };
        }
        
        // ============================================
        // APPS SCRIPT WEBHOOK - WRITE OPERATIONS
        // ============================================
        async function writeToSheet(action, data) {
            try {
                const payload = {
                    action: action,
                    data: {
                        ...data,
                        worker: currentUser.name,
                        createdBy: currentUser.username
                    }
                };
                
                const response = await fetch(CONFIG.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                // With no-cors, we can't read response but the data is saved
                return { success: true };
                
            } catch (error) {
                console.error('Write error:', error);
                return { success: false, error: error.message };
            }
        }
        
        // ============================================
        // FORM HANDLERS
        // ============================================
        async function handleDoorSales(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('saveDoorSalesBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            const totals = calculateDoorSalesTotal();
            
            const data = {
                date: document.getElementById('salesDate').value,
                session: 'Evening',
                players: parseInt(document.getElementById('playerCount').value) || 0,
                paper6Face: parseInt(document.getElementById('paper6Face').value) || 0,
                paper9Solid: parseInt(document.getElementById('paper9Solid').value) || 0,
                paper9Stripe: parseInt(document.getElementById('paper9Stripe').value) || 0,
                paperEarlybird: parseInt(document.getElementById('paperEarlybird').value) || 0,
                paperProg18: 0,
                paperProg3: 0,
                elec40: parseInt(document.getElementById('elec40').value) || 0,
                elec65: parseInt(document.getElementById('elec65').value) || 0,
                daubers: parseInt(document.getElementById('daubers').value) || 0,
                totalPaper: totals.paperTotal,
                totalElectronic: totals.electronicTotal,
                totalMisc: totals.miscTotal,
                grandTotal: totals.grandTotal
            };
            
            const result = await writeToSheet('saveDoorSales', data);
            
            if (result.success) {
                showToast('Door sales saved successfully!', 'success');
                document.getElementById('doorSalesForm').reset();
                document.getElementById('salesDate').value = new Date().toISOString().split('T')[0];
                calculateDoorSalesTotal();
                loadDashboardData();
                navigateTo('dashboard');
            } else {
                showToast('Failed to save door sales', 'error');
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Door Sales';
        }
        
        async function recordPullTabSale() {
            const gameId = document.getElementById('gameSelect').value;
            const amount = parseFloat(document.getElementById('saleAmount').value);
            
            if (!gameId || !amount) {
                showToast('Please select a game and enter amount', 'warning');
                return;
            }
            
            const selectedGame = pullTabGames.find(g => g.formNumber === gameId);
            if (!selectedGame) {
                showToast('Invalid game selection', 'error');
                return;
            }
            
            const data = {
                gameId: gameId,
                gameName: selectedGame.gameName,
                pricePerTicket: selectedGame.pricePerTicket,
                saleAmount: amount
            };
            
            const result = await writeToSheet('savePullTabSale', data);
            
            if (result.success) {
                showToast('Pull tab sale recorded!', 'success');
                document.getElementById('gameSelect').value = '';
                document.getElementById('saleAmount').value = '';
                loadDashboardData();
            } else {
                showToast('Failed to record sale', 'error');
            }
        }
        
        // ============================================
        // REPORT GENERATION
        // ============================================
        async function generateReport(reportType) {
            showToast(`Generating ${reportType} report...`, 'info');
            
            const result = await writeToSheet('generateReport', { reportType });
            
            if (result.success) {
                showToast('Report generated! Check your Google Drive.', 'success');
            } else {
                showToast('Failed to generate report', 'error');
            }
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            // Set message
            messageEl.textContent = message;
            
            // Set icon and class
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };
            
            icon.textContent = icons[type];
            toast.className = `toast ${type} show`;
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
